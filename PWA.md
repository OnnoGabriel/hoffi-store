# PWA Implementation Guide

This document provides detailed information about the Progressive Web App (PWA) implementation in Hoffi-App.

## Overview

Hoffi-App is a fully functional PWA that provides:
- **Offline functionality** through service worker caching
- **Installability** on mobile and desktop devices
- **Auto-updates** when new versions are deployed
- **App-like experience** with standalone display mode

## Architecture

### Service Worker

The service worker is automatically generated by `vite-plugin-pwa` using Workbox. It provides:

1. **Precaching**: All static assets are cached during installation
2. **Runtime caching**: External resources (CDN, fonts) are cached on first use
3. **Cache-first strategy**: Cached content is served immediately for fast loading
4. **Background sync**: Updates are downloaded in the background

### Manifest

The web app manifest (`manifest.webmanifest`) is auto-generated with:

```json
{
  "name": "Hoffi-App Lagerverwaltung",
  "short_name": "Hoffi-App",
  "description": "Lagerverwaltungssystem für metallverarbeitende Betriebe mit OCR-Unterstützung",
  "theme_color": "#1976D2",
  "background_color": "#ffffff",
  "display": "standalone",
  "orientation": "portrait",
  "scope": "/hoffi-app/",
  "start_url": "/hoffi-app/",
  "icons": [...]
}
```

## Configuration

### vite.config.js

```javascript
VitePWA({
  registerType: "autoUpdate",
  includeAssets: ["favicon.svg"],
  manifest: { /* ... */ },
  workbox: {
    globPatterns: ["**/*.{js,css,html,ico,png,svg,woff,woff2}"],
    runtimeCaching: [
      // CDN caching
      {
        urlPattern: /^https:\/\/cdn\.jsdelivr\.net\/.*/i,
        handler: "CacheFirst",
        options: {
          cacheName: "cdn-cache",
          expiration: {
            maxEntries: 10,
            maxAgeSeconds: 60 * 60 * 24 * 365, // 1 year
          },
        },
      },
      // Google Fonts caching
      {
        urlPattern: /^https:\/\/fonts\.googleapis\.com\/.*/i,
        handler: "CacheFirst",
        options: {
          cacheName: "google-fonts-cache",
          expiration: {
            maxEntries: 10,
            maxAgeSeconds: 60 * 60 * 24 * 365, // 1 year
          },
        },
      },
    ],
  },
  devOptions: {
    enabled: true,
    type: "module",
  },
})
```

### Key Configuration Options

- **registerType: "autoUpdate"**: Automatically activates new service workers
- **devOptions.enabled: true**: Enables PWA in development mode
- **globPatterns**: Defines which files to precache
- **runtimeCaching**: Configures caching strategies for external resources

## GitHub Pages Compatibility

The PWA is fully compatible with GitHub Pages deployment:

1. **Base URL**: Set to `/hoffi-app/` in `vite.config.js`
2. **Manifest scope**: Matches the base URL
3. **Start URL**: Points to the correct GitHub Pages path
4. **Icon paths**: Use absolute paths with base URL prefix

### Deployment

```bash
npm run build
git subtree push --prefix dist origin gh-pages
```

The service worker and manifest are automatically generated in the `dist/` directory during build.

## Local Development

PWA features work in development mode:

```bash
npm run dev
```

- Service worker registers at `http://localhost:3000`
- Manifest is served at `http://localhost:3000/manifest.webmanifest`
- Check DevTools → Application to inspect PWA status

## Icons

### Icon Sizes

- **192x192**: Minimum required size for Android
- **512x512**: Recommended size for splash screens
- **Maskable icons**: Include safe zone padding for adaptive icons

### Generating Icons

Run the provided script:

```bash
./generate-pwa-icons.sh
```

This requires ImageMagick and generates:
- Standard icons (any purpose)
- Maskable icons (with safe zone padding)

### Manual Icon Creation

If ImageMagick is not available, create icons manually:

1. Export `public/favicon.svg` at 192x192 and 512x512
2. For maskable icons, add 20% padding on all sides
3. Use a solid background color (#1976D2)

## Testing

### Local Testing

1. Start dev server: `npm run dev`
2. Open DevTools → Application
3. Check "Service Workers" section for registration
4. Check "Manifest" section for icon and metadata
5. Test "Add to Home Screen" functionality

### Production Testing

1. Build and deploy: `npm run build`
2. Visit GitHub Pages URL
3. Test installation on:
   - Android Chrome
   - iOS Safari
   - Desktop Chrome/Edge
4. Verify offline functionality by:
   - Installing the app
   - Disconnecting from network
   - Opening the installed app

## Browser Support

### Full PWA Support

- **Chrome/Edge 87+**: Full PWA support including installation
- **Safari 11.1+**: Partial support (no install prompt, manual "Add to Home Screen")
- **Firefox 79+**: Service worker support, limited installation

### iOS Specifics

- PWA installation only works in Safari
- No install prompt (must use "Add to Home Screen" manually)
- Limited background sync capabilities
- Service worker restrictions when not in use

## Troubleshooting

### Service Worker Not Registering

1. Check HTTPS (required except on localhost)
2. Verify no console errors
3. Check DevTools → Application → Service Workers
4. Clear cache and hard reload (Ctrl+Shift+R)

### Icons Not Showing

1. Verify icons exist in `public/` directory
2. Check icon paths in manifest
3. Clear browser cache
4. Verify correct MIME types (image/png)

### Updates Not Working

1. Service worker uses cache-first strategy
2. Updates download in background
3. Reload page to activate new version
4. Check "Update on reload" in DevTools for testing

### GitHub Pages Issues

1. Verify `base: "/hoffi-app/"` in vite.config.js
2. Check manifest scope and start_url match base
3. Ensure all icon paths include base URL
4. Clear GitHub Pages cache (may take a few minutes)

## Performance

### Caching Strategy

- **Static assets**: Precached during installation (~2-5 MB)
- **External resources**: Cached on first use
- **Cache expiration**: 1 year for CDN resources
- **Cache size**: Limited to 10 entries per cache

### Loading Performance

- **First load**: Downloads all assets (~2-5 MB)
- **Subsequent loads**: Instant from cache
- **Updates**: Background download, no blocking

### Offline Functionality

- All static assets available offline
- Camera and OCR work offline (after first load)
- Tesseract.js language data cached
- External fonts cached after first use

## Security

### HTTPS Requirement

Service workers require HTTPS except on localhost:
- GitHub Pages provides HTTPS automatically
- Local development works on `http://localhost`
- Network testing requires HTTPS certificate

### Permissions

The PWA requests:
- **Camera access**: For OCR functionality
- **Notification permission**: Not currently used
- **Storage**: For service worker caches

### Content Security Policy

No special CSP required, but ensure:
- Allow scripts from same origin
- Allow images from CDN if used
- Allow fonts from Google Fonts

## Future Enhancements

Potential PWA improvements:

1. **Background sync**: Sync data when connection restored
2. **Push notifications**: Alert users to updates
3. **Share target**: Allow sharing to the app
4. **Shortcuts**: Quick actions from app icon
5. **Update prompt**: UI to notify users of updates

## Resources

- [PWA Documentation](https://web.dev/progressive-web-apps/)
- [Workbox Documentation](https://developers.google.com/web/tools/workbox)
- [vite-plugin-pwa](https://vite-pwa-org.netlify.app/)
- [Web App Manifest](https://developer.mozilla.org/en-US/docs/Web/Manifest)
